<!DOCTYPE html>
<html lang="en">
<head>
  <title>Making Music With Math</title>


  <link href="https://fonts.googleapis.com/css?family=Unica+One|Vollkorn&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css" integrity="sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq" crossorigin="anonymous">

  <script src="./libraries/katex.min.js"></script>
  <script src="./libraries/p5.min.js"></script>
  <script src="./libraries/marked.min.js"></script>
  <script src="./libraries/vue.js"></script>
  <script src="./libraries/vue-observe-visibility.min.js"></script>
  <script src="./libraries/audio.js"></script>
  <!--<script src="./libraries/plotly.min.js"></script>-->

  <link rel="stylesheet" type="text/css" href="style.css">

  <meta name="description" content="Making Music With Math" />
</head>
<body>

<div id="root" class="container">
<md>
# Making Music with Math
### A Guide to Synthesizing Sounds with the Wave Equation

A vibrating string obeys the [wave equation](https://en.wikipedia.org/wiki/Wave_equation). This equation governs how each part of the string vibrates. Using this equation, it's possible to simulate the motion of a vibrating string and generate musical tones, such as that of a plucked guitar string or a struck piano string. In this post we'll explain how you can do this.

## The Ideal String

To get started, let's take a look at the wave equation.

$$ \frac{\partial^2 y}{\partial t^2} = c^2 \frac{\partial^2 y}{\partial x^2} $$

This can be written more concisely as

$$\ddot{y} = c^2 y''$$

In words, this is saying that the vertical acceleration of any point along the string is proportional to the curvature at that point.

Here, x refers to the position along the string, and t refers to time. $y(x,t)$ is a function of position and time, and tells us the displacement (height) of a point a distance $x$ along the string at a particular moment in time $t$. So this function captures the motion of the entire string over time. Finally, $c$ is the speed of the travelling wave moving along the string.

A general solution to the wave equation is:

$$ y = (A \sin (k x) + B \cos (k x)) (C \sin(\omega t) + D \cos(\omega t)) $$

This works because $y'' = - k^2 y $ & $\ddot{y} = -\omega^2 y$, so the wave equation is satisfied so long as $\omega = \pm c k$.

The next step is to impose the boundary conditions of the string. The string is fixed at both ends, which means that
$$ y(0,t) = 0 $$
$$ y(L,t) = 0 $$

Applying the first condition tell us that $B=0$, while applying the second condition tells us that $k = \frac{n\pi}{L}$ for $n = 1,2,3,...$

So, our general solution becomes

$$ y_n = \sin (k_n x) \big( A_n \cos(\omega_n t) + B_n \sin(\omega_n t) \big)$$

where we've redefined our coefficients as $A_n$ and $B_n$, and $k_n = \frac{n \pi}{L}$, $\omega_n = c \frac{n \pi}{L}$

These $y_n$ are known as the *normal modes* of the string. Let's visualize what the first few of these normal modes look like.
</md>

<animation :vars="stringnormalmodes" :sliders="{n: ['Mode Number', 1, 6, 1]}" :code="`

function graph(x, t, n, a, b) {
  let k = n * Math.PI;
  let c = 0.375;
  let w = c * k;

  return Math.sin(k * x) * (a * Math.sin(w * t) + b * Math.cos(w * t));
}

`">
</animation>

<md>
Every normal mode is a possible way in which the string can vibrate. As we increase $n$, the oscillations become more energetic as the string oscillates more rapidly. The frequency of vibration of each normal mode $f_n$ is related to $\omega_n$ by $f_n = \frac{\omega_n}{2 \pi} = n \frac{c}{2 L} = n f$.

Notice that just by requiring the string to be fixed at its ends, the wave equation ensures that the string can only vibrate at a certain allowable set of frequencies (f, 2f, 3f, ...). The allowed vibration frequencies for the ideal string are integer multiples of a fundamental frequency f. Together, these frequencies are known as the *harmonics* of the string.

We can add different normal modes together to get more complicated vibration patterns. Just for fun, in the interactive below you can drag the sliders to mix in different amounts of the first 6 normal modes (we're adjusting the A parameter here, the B parameter is set to zero). When you're done, turn up the speed slider to unfreeze the wave and watch the ensuing wave motion.
</md>

<animation :vars="mixingmodes" :sliders="{A1: ['1st mode', 0, 1, 0.01], A2: ['2nd mode', 0, 1, 0.01], A3: ['3rd mode', 0, 1, 0.01], A4: ['4th mode', 0, 1, 0.01], A5: ['5th mode', 0, 1, 0.01], A6: ['6th mode', 0, 0.5, 0.01], c: ['Speed', 0, 1, 0.01]}" :code="`

function graph(x, t, c, ...a) {

  let y = 0;

  for (let n=1; n<=6; n++) {
    let k = n * Math.PI;
    let w = c * k;
    y += Math.sin(k * x) * (a[n-1] * Math.cos(w * t))
  }

  return y/6;
}

`">
</animation>

<md>

A somewhat amazing fact is that any allowable string shape can be expressed as a sum of different normal modes! So, the most general type of string vibration is

$$
\begin{aligned}
   y &= y_1 + y_2 + y_3 + \ldots \\
   &= \sum_{n=1}^\infty y_n
\end{aligned}
$$

Or,
$$
y = \sum_{n=1}^\infty \sin (k_n x) \big( A_n \cos(\omega_n t) + B_n \sin(\omega_n t) \big)
$$

where $k_n = \frac{n \pi}{L}$, $\omega_n = c \frac{n \pi}{L}$, and $c$ is the speed of the travelling wave in the string.

Solving the wave equation now amounts to working out the coefficients $A_n$ and $B_n$. Once we know these coefficients, plugging them into the equation above gives us the motion of every point on the string for all time.

Every kind of waveform that you might be familiar with, from a square wave to a triangle wave to a sawtooth wave can be represented as a certain set of these $A_n$ and $B_n$ coefficients. (For example, the coefficients for these standard waveforms are [provided here](https://webaudio.github.io/web-audio-api/#oscillator-coefficients).)

To obtain these coefficients, we need to know something more about the string. In particular, we need to know the initial position and initial velocity of the string, which we can write as $f(x)$ and $g(x)$.

$$ y(x,0) = f(x) $$
$$ \dot{y}(x,0) = g(x) $$

If $g(x) = 0$, then each point on the string starts off with zero initial velocity but with some initial shape provided by $f(x)$. We call this a plucked string. On the other hand, if $f(x) = 0$, then the string starts off completely flat, but with an initial velocity distribution provided by $g(x)$. We call this a struck strung. Let's consider these two cases separately.

## The Plucked Ideal String

If the string is plucked, it has zero initial velocity. So,

$$ \dot{y}(x,0) = 0 $$

A little math shows that

$$
\begin{aligned}
\dot{y}(x,0) &= \sum_{n=1}^\infty \sin (k_n x) \big( -A_n \omega_n \sin(0) + B_n \omega_n \cos(0) \big) \\
&= \sum_{n=1}^\infty \sin (k_n x) B_n \omega_n
\end{aligned}
$$

For this to be zero, it must be the case that $B_n = 0$ for all $n$. So our general solution for the case of the plucked string reduces to

$$ y = \sum_{n=1}^\infty A_n \sin (k_n x)  \cos(\omega_n t)$$

Let's assume that we know the initial shape of the string, which we represent by the function $f(x)$.

$$ y(x,0) = f(x) $$

So,

$$ f(x) = \sum_{n=1}^\infty A_n \sin (\frac{n \pi x}{L}) $$

To solve this equation, we need to find the values of all the $A_n$. We can do so using the classic [Fourier trick](https://books.google.com/books?id=Kh4xDwAAQBAJ&pg=PA134&dq=Fourier%27s+trick+griffiths&hl=en&newbks=1&newbks_redir=0&sa=X&ved=2ahUKEwib2eD80_blAhWLjFkKHY8YB9oQ6AEwAHoECAQQAg#v=onepage&q&f=false)

$$ \int_{0}^{L} \sin (\frac{n \pi x}{L}) \sin (\frac{m \pi x}{L}) = \frac{L}{2} \delta_{m,n}$$

where $\delta_{m,n} = 1$ if $m=n$, and zero otherwise.

Applying this identity and a little algebra, we end up with an equation for the coefficients (known as Fourier coefficients).

$$ A_n =  \frac{2}{L} \int_{0}^{L} f(x) \sin (\frac{n \pi x}{L}) dx$$

This solves the case of the ideal plucked string.

Let's try an example. Say that the string is plucked at a length $l$ along the string, with an initially triangular string shape.

$$
f(x) = \begin{cases}
   h \frac{x}{l} & \text{if } x \leq l \\
   h (1 - \frac{x}{L})\frac{L}{L-l} & \text{if } l < x \leq L
\end{cases}
$$

Here's what this function for the plucked guitar string shape looks like.</md>


<animation :vars="trianglecurve" :sliders="{l: ['Pluck position', 0.1, 0.9, 0.01], h: ['Pluck height', -1, 1, 0.01]}" :code="`

function graph(x, t, l, h) {
  return x <= l ? h * x/l : h * (1 - x) / (1-l);
}

`"></animation>

<md>
We can plug this function into to our integral for $A_n$, and use a tool like Wolfram Alpha to solve the integral. The [solution](https://www.wolframalpha.com/input/?i=%282%2FL%29*%28Integrate%5Bsin%28n+pi+x+%2F+L%29+*+h*x%2Fl%2C%7Bx%2C0%2Cl%7D%5D+%2B+Integrate%5Bsin%28n+pi+x+%2F+L%29+*+h*%281-x%2FL%29*%28L%2F%28L-l%29%29%2C%7Bx%2Cl%2CL%7D%5D%29)  is

$$ A_n = \frac{1}{n^2 \pi^2} \frac{2 h}{l (1-\frac{l}{L})} \big( L \sin(\frac{n \pi l}{L}) - l \sin (n \pi)\big)$$

Let's animate this solution for the first $N$ terms in the sum.

$$ y(x,t) = \sum_{n=1}^{N} A_n \sin (k_n x) \cos(\omega_n t)$$

</md>

<animation :vars="pluckedstring" :sliders="{N: ['Number of terms', 1, 15, 1], l: ['Pluck position', 0.1, 0.9, 0.01]}" :code="`

function graph(x, t, N, l) {
  let c = 0.375;
  let y = 0;

  for (let n=1; n<=N; n++) {
    let k = n * Math.PI;
    let w = c * k;
    let a = (1/Math.pow((n*Math.PI),2)) * (2/(l * (1-l))) * (Math.sin(n * Math.PI * l) - l * Math.sin(n * Math.PI));

    y += a * Math.sin(k * x) * Math.cos(w * t);

  }

  return y;
}

`"></animation>

<md>
The animation above shows the motion of the string following the initial pluck.

Let's use this to make sound. To extract the waveform $w(t)$, we want only the time dependent part of the string motion.

$$ w(t) = \sum_{n=1}^{N} A_n \cos(\omega_n t)$$


</md>

<animation :vars="pluckedstring" :sliders="{N: ['Number of terms', 1, 15, 1], l: ['Pluck position', 0.1, 0.9, 0.01]}" :code="`

function graph(x, t, N, l) {

  let c = 0.375;
  let y = 0;

  for (let n=1; n<=N; n++) {
    let k = n * Math.PI;
    let w = c * k;
    let a = (1/Math.pow((n * Math.PI),2)) * (2/(l * (1-l))) * (Math.sin(n * Math.PI * l) - l * Math.sin(n * Math.PI));

    y += a * Math.cos(w * x * 20);

  }

  return y/1.5;
}

`"></animation>

<md>
  Let's make sound with this. To do this, we first need to make a few changes.

  - Rewrite $\omega_n$ in terms of the fundamental frequency of the tone, so $\omega_n = 2 \pi n f$.

  - Each term in the waveform can be represented with an oscillator using the [createPeriodicWave()](https://developer.mozilla.org/en-US/docs/Web/API/BaseAudioContext/createPeriodicWave) WebAudio function.

  - Let's also assume that each oscillator decays exponentially with a time period $\tau_n$ that depends on its frequency (higher frequencies decay faster than lower ones). For example, we can choose $\tau_n = \frac{\tau}{n}$ where $\tau$ is a characteristic fade time (in seconds).


  Making these changes, we end up with the following waveform.

  $$ w(t) = \sum_{n=1}^{N} A_n \cos(2 \pi n f t) e ^{  - n t / \tau }$$

  Here's what this sounds like.
</md>


<animation :vars="pluckedstring" :sliders="{N: ['Number of terms', 1, 15, 1], l: ['Pluck position', 0.1, 0.9, 0.01]}">

  <div class="center-inline">
    <div> Fundamental Frequency = {{freq}} </div> &nbsp;&nbsp;
    <input type="range" :min="100" :max="1000" :step="1" v-model.number="freq"></input>
  </div>

  <button @click="playPluckedString" style="margin-top: 5px;">Play Sound</button>
</animation>

<md>
  Notice that as the pluck position moves towards the edge of the string, the sound becomes brighter.

  Let's also try a different approach to creating the waveform. Suppose that the waveform is given by the slope of the string at the end, i.e.

  $$
  \begin{aligned}
  w(t) &= y'(L,t) \\
  &= \sum_{n=1}^{N} A_n k_n \cos(n \pi) \cos(\omega_n t) \\
  &= \sum_{n=1}^{N} (-1)^{n} A_n k_n \cos(\omega_n t)
  \end{aligned}
  $$

  Let's take a look at what this waveform looks like.
</md>


<animation :vars="pluckedstring" :sliders="{N: ['Number of terms', 1, 15, 1], l: ['Pluck position', 0.1, 0.9, 0.01]}" :code="`

function graph(x, t, N, l) {

  let c = 0.375;
  let y = 0;

  for (let n=1; n<=N; n++) {
    let k = n * Math.PI;
    let w = c * k;
    let a = (1/Math.pow((n * Math.PI),2)) * (2/(l * (1-l))) * (Math.sin(n * Math.PI * l) - l * Math.sin(n * Math.PI));

    y += Math.pow(-1, n) * a * k * Math.cos(w * x * 20);

  }

  return y/5;
}

`"></animation>

<md>
  Once again, we can apply use WebAudio oscillators to synthesize this sound, and apply an exponential decay to each oscillator to fade the sound.
</md>

<animation :vars="pluckedstring" :sliders="{N: ['Number of terms', 1, 15, 1], l: ['Pluck position', 0.1, 0.9, 0.01]}">

  <div class="center-inline">
    <div> Fundamental Frequency = {{freq}} </div> &nbsp;&nbsp;
    <input type="range" :min="100" :max="1000" :step="1" v-model.number="freq"></input>
  </div>

  <button @click="playPluckedString2" style="margin-top: 5px;">Play Sound</button>
</animation>

<md>
  In this case, the sound has a harsher attack. When plucked at the center, the waveform resembles a square wave.
</md>


</div>

<!-- page code -->
<script src="vue-definitions.js"></script>

</body>
</html>