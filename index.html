<!DOCTYPE html>
<html lang="en">
<head>
  <title>Making Music With Math</title>


  <link href="https://fonts.googleapis.com/css?family=Unica+One|Vollkorn&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css" integrity="sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq" crossorigin="anonymous">

  <script src="./libraries/katex.min.js"></script>
  <script src="./libraries/p5.min.js"></script>
  <script src="./libraries/marked.min.js"></script>
  <script src="./libraries/vue.js"></script>
  <script src="./libraries/vue-observe-visibility.min.js"></script>
  <script src="./libraries/audio.js"></script>
  <!--<script src="./libraries/plotly.min.js"></script>-->

  <link rel="stylesheet" type="text/css" href="style.css">

  <meta name="description" content="Making Music With Math" />
</head>
<body>

<div id="root" class="container">
<md>
# Making Music with Math
### A Guide to Synthesizing Sounds with the Wave Equation

An idealized vibrating string obeys the [wave equation](https://en.wikipedia.org/wiki/Wave_equation). This equation tells us how each part of a string will move at each moment in time. Using this equation, it's possible to approximately simulate the motion of a plucked guitar string or a struck piano string. In this post we'll explain how you can do this.

## The Ideal String

The wave equation for an ideal string is

$$ \frac{\partial^2 y}{\partial t^2} = c^2 \frac{\partial^2 y}{\partial x^2} $$

Or, more concisely,

$$\ddot{y} = c^2 y''$$

Here, $c$ is the speed of the travelling wave moving along the string. This equation tells us that the acceleration of any point along the string is proportional to the curvature at that point. For now, we're ignoring energy dissipation from friction and any stiffness in the string, which is why this is an **ideal** string.

The goal is to find $y(x,t)$, which tells us the height of every point along the string $(x)$ at any moment in time $(t)$.

The general solutions for the motion of a vibrating string whose ends are fixed are

$$ y_n = \sin (k_n x) \big( A_n \cos(\omega_n t) + B_n \sin(\omega_n t) \big)$$

where $k_n = \frac{n \pi}{L}$, $\omega_n = c \frac{n \pi}{L}$, $n = 1,2,3,...$, and $A_n$ and $B_n$ are coefficients to be determined.

We can verify that these solutions obeys the wave equation so long as $\omega_n^2 = c^2 k_n^2$. We can also verify that they are fixed at the ends, i.e.

$$ y_n(0,t) = 0 $$
$$ y_n(L,t) = 0 $$

The $y_n$ provided by the above equation are known as the *normal modes* of the string. These represent all the simplest possible ways in which a string can vibrate. Let's visualize what the first few of these normal modes look like.
</md>

<animation :vars="stringnormalmodes" :sliders="{n: ['Mode Number', 1, 6, 1]}" :code="`

function graph(x, t, n, a, b) {
  let k = n * Math.PI;
  let c = 0.375;
  let w = c * k;

  return Math.sin(k * x) * (a * Math.sin(w * t) + b * Math.cos(w * t))/n;
}

`">
</animation>

<md>
As we increase $n$, the string oscillates more rapidly. The frequency of vibration of each normal mode $f_n$ is related to $\omega_n$ by $f_n = \frac{\omega_n}{2 \pi} = n \frac{c}{2 L} = n f$.

Notice that just by requiring the string to be fixed at its ends, the wave equation ensures that an ideal string can only vibrate at a certain allowable set of frequencies (f, 2f, 3f, ...). Together, these frequencies are known as the *harmonics* of the string.

The wave equation is a **linear equation**, which means that if $y_1$ is a solution and $y_2$ is a solution, then any combination of the form $a y_1 + b y_2$ is also a solution. So, in general we can add together various normal modes to obtain more complex allowed string vibration patterns.

Just for fun, in the interactive below you can drag the sliders to mix in different amounts of the first 6 normal modes (here we're adjusting the $A_n$ coefficients, and the $B_n$ coefficients are set to zero). When you're done, turn up the speed slider to unfreeze the wave and watch the ensuing wave motion.
</md>

<animation :vars="mixingmodes" :sliders="{A1: ['1st mode', 0, 1, 0.01], A2: ['2nd mode', 0, 1, 0.01], A3: ['3rd mode', 0, 1, 0.01], A4: ['4th mode', 0, 1, 0.01], A5: ['5th mode', 0, 1, 0.01], A6: ['6th mode', 0, 0.5, 0.01], c: ['Speed', 0, 1, 0.01]}" :code="`

function graph(x, t, c, ...a) {

  let y = 0;

  for (let n=1; n<=6; n++) {
    let k = n * Math.PI;
    let w = c * k;
    y += Math.sin(k * x) * (a[n-1] * Math.cos(w * t))
  }

  return y/6;
}

`">
</animation>

<md>

A somewhat amazing fact is that any allowable string shape can be expressed as a sum of different normal modes! So, the most general type of string vibration is

$$
\begin{aligned}
   y &= y_1 + y_2 + y_3 + \ldots \\
   &= \sum_{n=1}^\infty y_n
\end{aligned}
$$

Or,
$$
y = \sum_{n=1}^\infty \sin (k_n x) \big( A_n \cos(\omega_n t) + B_n \sin(\omega_n t) \big)
$$

where $k_n = \frac{n \pi}{L}$, $\omega_n = c \frac{n \pi}{L}$, and $c$ is the speed of the travelling wave in the string.

**Solving the wave equation in a particular situation amounts to working out the coefficients $A_n$ and $B_n$. Once we know these coefficients, we can plug them into the equation above to obtain a formula for the motion of every point on the string for all time.**

But how do we find these coefficients? To do this, we need to know something more about the string. In particular, we need to know the **initial position** and the **initial velocity** of the string, which we can write as $f(x)$ and $g(x)$.

$$ y(x,0) = f(x) $$
$$ \dot{y}(x,0) = g(x) $$

If $g(x) = 0$, then each point on the string starts off with zero initial velocity but with some initial shape provided by $f(x)$. We call this a plucked string.

On the other hand, if $f(x) = 0$, then the string starts off completely flat, but with an initial velocity distribution provided by $g(x)$. We call this a struck strung.

Let's consider these two cases separately.

## The Plucked Ideal String

The general solution for the case of the plucked string reduces to

$$ y = \sum_{n=1}^\infty A_n \sin (k_n x)  \cos(\omega_n t)$$

Let's say we know the initial shape of the string, which we call $f(x)$.

$$ y(x,0) = f(x) $$

Expanding out $y$ and substituting $k_n = \frac{n \pi}{L}$,

$$ f(x) = \sum_{n=1}^\infty A_n \sin (\frac{n \pi x}{L}) $$

We want to solve this for $A_n$. Using the classic [Fourier trick](https://books.google.com/books?id=Kh4xDwAAQBAJ&pg=PA134&dq=Fourier%27s+trick+griffiths&hl=en&newbks=1&newbks_redir=0&sa=X&ved=2ahUKEwib2eD80_blAhWLjFkKHY8YB9oQ6AEwAHoECAQQAg#v=onepage&q&f=false) and some algebraic rearrangement, we end up with an equation for $A_n$.

$$ A_n =  \frac{2}{L} \int_{0}^{L} f(x) \sin (\frac{n \pi x}{L}) dx$$

This equation solves the case of the ideal plucked string.

Let's try an example. Say that the string is plucked at a length $l$ along the string, with an initially triangular string shape.

$$
f(x) = \begin{cases}
   h \frac{x}{l} & \text{if } x \leq l \\
   h \frac{L - x}{L - l} & \text{if } l < x \leq L
\end{cases}
$$

Here's what this function for the plucked guitar string shape looks like.</md>


<animation :vars="trianglecurve" :sliders="{l: ['Pluck location', 0.1, 0.9, 0.01], h: ['Pluck height', -1, 1, 0.01]}" :code="`

function graph(x, t, l, h) {
  return x <= l ? h * x/l : h * (1 - x) / (1-l);
}

`"></animation>

<md>
We can plug this function into to our integral for $A_n$, and use a tool like Wolfram Alpha to solve the integral. The [solution](https://www.wolframalpha.com/input/?i=%282%2FL%29*%28Integrate%5Bsin%28n+pi+x+%2F+L%29+*+h*x%2Fl%2C%7Bx%2C0%2Cl%7D%5D+%2B+Integrate%5Bsin%28n+pi+x+%2F+L%29+*+h*%281-x%2FL%29*%28L%2F%28L-l%29%29%2C%7Bx%2Cl%2CL%7D%5D%29)  is

$$ A_n = \frac{1}{n^2 \pi^2} \frac{2 h L^2}{l (L- l)}  \sin(\frac{n \pi l}{L})$$

Let's animate this solution for the first $N$ terms in the sum.

$$ y(x,t) = \sum_{n=1}^{N} A_n \sin (k_n x) \cos(\omega_n t)$$

</md>

<animation :vars="string" :sliders="{N: ['Number of terms', 1, 10, 1], l: ['Pluck location', 0.1, 0.9, 0.01]}" :code="`

function graph(x, t, N, l) {
  let c = 0.375;
  let y = 0;

  for (let n=1; n<=N; n++) {
    let k = n * Math.PI;
    let w = c * k;
    let a = (1/Math.pow((n*Math.PI),2)) * (2/(l * (1-l))) * Math.sin(n * Math.PI * l);

    y += a * Math.sin(k * x) * Math.cos(w * t);

  }

  return y;
}

`"></animation>

<md>
The animation above shows the motion of the string following the initial pluck. Notice that the string motion is periodic, as the string returns to its starting position and repeats the motion.

The next step is to extract an audio waveform from this string motion. For the waveform $w(t)$, we want only the time-dependent part of the string motion.

$$ w(t) = \sum_{n=1}^{N} A_n \cos(\omega_n t)$$

</md>

<animation :vars="string" :sliders="{N: ['Number of terms', 1, 10, 1], l: ['Pluck position', 0.1, 0.9, 0.01]}" :code="`

function graph(x, t, N, l) {

  let c = 0.375;
  let y = 0;

  for (let n=1; n<=N; n++) {
    let k = n * Math.PI;
    let w = c * k;
    let a = (1/Math.pow((n * Math.PI),2)) * (2/(l * (1-l))) * Math.sin(n * Math.PI * l);

    y += a * Math.cos(w * x * 20);

  }

  return y/1.5;
}

`"></animation>

<md>
  The interactive above shows you the waveform for the plucked string. Notice how it changs depending on where you pluck the string.

  To make sound with this waveform, we first need to do a couple of things.

  - Rewrite $\omega_n$ in terms of the fundamental frequency of the tone, so $\omega_n = 2 \pi n f$.
  - Let's assume that each sine or cosine function decays exponentially with a time period $\tau_n$ that depends on its frequency (higher frequencies decay faster than lower ones). Following [this reference](http://large.stanford.edu/courses/2007/ph210/pelc2/), we can choose $\tau_n = \frac{\tau}{n}$ where $\tau$ is a characteristic fade time (in seconds).


  Making these changes, we end up with the following waveform.

  $$ w(t) = \sum_{n=1}^{N} A_n \cos(2 \pi n f t) e ^{ - n t / \tau }$$

  We can synthesize this using the [createPeriodicWave()](https://developer.mozilla.org/en-US/docs/Web/API/BaseAudioContext/createPeriodicWave) WebAudio function. Here's what this sounds like.
</md>


<animation :vars="string" :sliders="{N: ['Number of terms', 1, 10, 1], l: ['Pluck position', 0.1, 0.9, 0.01]}">

  <div class="center-inline">
    <div> Fundamental Frequency = {{freq}} </div> &nbsp;&nbsp;
    <input type="range" :min="110" :max="440" :step="1" v-model.number="freq"></input>
  </div>

  <button class="button" @click="playPluckedString" style="margin-top: 5px;">PLAY STRING</button>

  <button class="button" @click="strumPluckedString([1, 5/4, 3/2])" style="margin-top: 5px;">STRUM MAJOR CHORD</button>

  <button class="button" @click="strumPluckedString([1, 6/5, 3/2])" style="margin-top: 5px;">STRUM MINOR CHORD</button>

</animation>

<md>
  Notice that as the pluck position moves towards the edge of the string, the sound becomes brighter.

  ## The Struck Ideal String

  In the struck string, the general solution becomes

  $$
  y = \sum_{n=1}^{\infty} B_n \sin (k_n x) \sin(\omega_n t)
  $$

  where $k_n = \frac{n \pi}{L}$ and $\omega_n = c \frac{n \pi}{L}$.

  To solve for $B_n$, we need to use the fact that we know the initial velocity distribution $g(x)$.

  $$
  g(x) = \dot{y} (x,0)
  $$

  Taking the time derivative and substituting in $k_n$, we arrive at

  $$
  g(x) = \sum_{n=1}^{\infty} B_n \omega_n \sin (\frac{n \pi x}{L})
  $$

  Once again, this equation is solvable using Fourier's trick, resulting in the solution

  $$
  B_n = \frac{2}{\omega_n L} \int_{0}^{L} g(x) \sin (\frac{n \pi x}{L}) dx
  $$

  For example, suppose that we strike the string with a velocity impulse concetrated at a point located a distance $l$ along the string. This would be like striking the string with the edge of a knife. We can model this velocity distribution as a delta function.

  $$ g(x) = v L \delta (x-l) $$

  Where $v$ is the speed with which the string is struck, and the delta function $\delta (x-l)$ has the property that $ \int_{0}^{L} f(x) \delta (x - l) dx = f(l) $ if $0 \leq l \leq L$. (The extra factor of L is there to make the units work out.)

  Performing the integral, we arrive at the solution

  $$
  B_n = \frac{2 v}{\omega_n} \sin (\frac{n \pi l}{L})
  $$

  Let's animate this solution for the first $N$ terms in the sum.

  $$ y(x,t) = \sum_{n=1}^{N} B_n \sin (k_n x) \sin(\omega_n t)$$


</md>

<animation :vars="string" :sliders="{N: ['Number of terms', 1, 10, 1], l: ['Strike location', 0.1, 0.9, 0.01]}" :code="`

function graph(x, t, N, l) {
  let c = 0.375;
  let v = 0.5;
  let y = 0;

  for (let n=1; n<=N; n++) {
    let k = n * Math.PI;
    let w = c * k;
    let a = (2 * v / w) * Math.sin(n * Math.PI * l);

    y += a * Math.sin(k * x) * Math.sin(w * t);

  }

  return y;
}

`"></animation>

<md>
  If you strike the string near one of its ends, you can watch the pulse propagating along the string, and reflecting off the ends.

  Once again, let's visualize the waveform. We can obtain the waveform by throwing away the spatial part of the string motion, and only holding on to the time-dependent part.

  $$
    w(t) = \sum_{n=1}^{N} B_n \sin(\omega_n t)
  $$
</md>

<animation :vars="string" :sliders="{N: ['Number of terms', 1, 10, 1], l: ['Strike location', 0.1, 0.9, 0.01]}" :code="`

function graph(x, t, N, l) {
  let c = 0.375;
  let v = 0.5;
  let y = 0;

  for (let n=1; n<=N; n++) {
    let k = n * Math.PI;
    let w = c * k;
    let a = (2 * v / w) * Math.sin(n * Math.PI * l);

    y += a * Math.sin(w * x * 20);

  }

  return y/1.5;
}

`"></animation>

<md>
  Here's what this sounds like, after adding in an exponential fade.
</md>

<animation :vars="string" :sliders="{N: ['Number of terms', 1, 10, 1], l: ['Pluck position', 0.1, 0.9, 0.01]}">

  <div class="center-inline">
    <div> Fundamental Frequency = {{freq}} </div> &nbsp;&nbsp;
    <input type="range" :min="110" :max="440" :step="1" v-model.number="freq"></input>
  </div>

  <button class="button" @click="playStruckString" style="margin-top: 5px;">PLAY STRING</button>

  <button class="button" @click="strumStruckString([1, 5/4, 3/2])" style="margin-top: 5px;">STRUM MAJOR CHORD</button>

  <button class="button" @click="strumStruckString([1, 6/5, 3/2])" style="margin-top: 5px;">STRUM MINOR CHORD</button>

</animation>


<md>
  The struck string has a slightly harsher / brighter sound than the plucked string. This is because it has more energy in higher harmonics. The amplitudes corresponding to the $n^{\text{th}}$ harmonic in the plucked string fall off as $A_n \propto \frac{1}{n^2}$, but in the struck string they fall off as $B_n \propto \frac{1}{n}$.

</md>

</div>

<!-- page code -->
<script src="vue-definitions.js"></script>

</body>
</html>